# prometheusGrafanaHardwareMetrics

## Introduction 
This repository was created to help retrieving hardware and software metrics from an edge device, and persist those metrics. This need to get and store that data was generated by the stress test done to the edge hardware, the reports were lost when the device crashed, and the inability to get necessary information to debug the problem.

To get and persist the necessary data from the edge were selected Prometheus and his exporters.
The exporters will retrieve the information and provide the retrieval of that information by an Rest API. Prometheus by the other side will gather the information of the exporters, store it, and using the portal give the ability to show the information with charts.

Besides persisting the information Prometheus has the capacity to provide that information to other services. Grafana is one of those services, that give us the ability to connect to a database and give the user a chance to create dashboards and charts, giving us a more user friendly way to view the metrics that we want. Those charts can be created with queries that enables the user to filter the data with more precision.

## Getting Started
This project is set to run with the `docker-compose`, and since the idea is to set the exporters in one equipment and Prometheus and Grafana on  other two docker compose files were created.
The `docker-compose.yml` file, on the project root, is the configuration to start the Grafana and Prometheus, `docker-compose-exporters.yml` will start the containers for the exporters.

To be able to use this the machine(s) where this will run need to have `docker` and `docker-compose` installed, and to get information on how to install them visit:
 - https://docs.docker.com/get-docker/
 - https://docs.docker.com/compose/install/

To be able to run the services as they are, all the containers need to be running in the same computer. They are configured to use the same docker network and they use the service name to access each other, this can only be done if they are in the network `prometheus-grafana-docker-compose_monitoring`.

To change these configurations and be able to connect the Prometheus and the extractors from different networks, we need to change the file `prometheus.yml` in the path `/prometheus/conf`, and change the targets values to the IP address of the exporters (lines 19 and 27).

To be able to run Prometheus and Grafana from different networks the Grafana's data source configuration should be changed to set the valid IP of Prometheus. Should change the `url` value (line 7) from the file `/grafana/provisioning/datasources/automatic.yml` to the correct IP.

 ### Project structure
 ```
 /root
    /grafana
        /data
        /provisioning
            /dashboard
                /dashboard.yaml
                /named-processes_rev2.json
                /node-exporter-full_rev27.json
            /datasources
                /automatic.yml
    /processExporter
        /conf
            /process-exporter.yml
    /prometheus
        /conf
            /prometheus.yml
        /data
    /docker-compose-exporters.yml
    /docker-compose.yml
    /run_exporters.sh
    /run_importers.sh
```

#### Process Exporter
This exporter has a folder in the project to store a configuration file, that could be used to filter the processes that the application will monitor. For now it is not set to filter any process specifically, for more information about this check the links section at the bottom.

#### Prometheus
The folder contains the configuration file (`/conf/prometheus.yml`), where we have defined the jobs for each of the exporters configurations.
It is needed another folder, the `/data` folder, where Prometheus will store the metrics retrieved from the exporters.

#### Grafana
For this service we have more configuration files and folders then the other services. The `/data` folder is where Grafana will store all the configurations, this folder is important because is there that it will save the customizations done by the users (ex. dashboards, charts, data sources).
The `/provisioning` folder has two sub-folders, the `/dashboards` folder has the configuration to import the dashboards the are in the same folder exported as JSON files. The `/datasources/automatic.yml` has the configuration to set the Prometheus service as the data source.

## Run the containers
To run all the containers exist two docker compose configuration files, on for the extractor and the other for the Prometheus and Grafana.

### docker-compose-exporters.yml
To start the container configured in this file you could execute the folowing:
 - `docker-compose -f docker-compose-exporters.yml up` (run dockers attached to the cmd)
 - `docker-compose -f docker-compose-exporters.yml -d up` (run dockers detached from the cmd)
  - `./run_exporters.sh` (run dockers attached to the cmd)

The containers generated by this configuration file will be set to the docker network `prometheus-grafana-docker-compose_monitoring`, with the exporters ports exposed and mapped to the host.
 - node exporter
    - expose: `9100`
    - map to host: `9100:9100`
 - process exportere
    - expose: `9256`
    - map to host: `9256:9256`

The expose will expose the ports to the docker network, and the mapping will enable the access from the host to the container port. So with mapping we can access the container by `http://127.0.0.1:{port}`, and we could open this port to the network that the computer is connected to and be able to access the exporters from other machine.

### docker-compose.yml
For the other services, is on this file that the configurations are stored and can be executed with:

 ```
 export UserID=${UID}
 docker-compose up
 ``` 
 (run dockers attached to the cmd)
 
  ```
 export UserID=${UID}
 docker-compose -d up
 ``` 
 (run dockers detached from the cmd)

`./run_importers.sh` (run dockers attached to the cmd)

The configurations have volumes that will map the folders that the services use to store data, to the `/data` folders on each of the services folders on the project (`/grafana/data`, `/prometheus/data`). IF THESE FOLDERS DO NOT EXIST IN THE PROJECT, CREATE THEM BEFORE STARTING THE CONTAINERS.
To the container services have permissions to write on the volumes folders, we need to a user on the configurations. To retrieve the user id to a variable used on the config file we need to create the environment variable `UserID` (`export UserID=${UID}`), that is the reason that we need to execute a command before the `docker-compose` command.
As the exporters these containers have the services ports exposed and mapped:
 - grafana
    - expose: `3000`
    - map to host: `3000:3000`
 - prometheus
    - expose: `9090`
    - map to host: `9090:9090`

## Access the services

After all the containers are up and running, with a valid configuration, we should be able to access the portals of Prometheus and Grafana.

### Prometheus
To access Prometheus access the URL `http://127.0.0.1:9090` in your browser. There you can validate that the extractors are connected, opening the `Status->Targets`, and check the metrics using the search bar on the home page.

### Grafana
The portal from Grafana is available by the URL `http://127.0.0.1:3000`, with the credentials `admin/password`. Here the data source should already be configured, and can be viewed in the Configuration->Data sources. The dashboards already imported are available in the home page section Dashboards.

## Links
### Prometheus
 - https://prometheus.io/
 - https://prometheus.io/docs/introduction/overview/
 - https://prometheus.io/docs/guides/node-exporter/
 - https://alexandre-vazquez.com/how-storage-works-in-prometheus-and-why-is-this-important/
 - https://prometheus.io/docs/instrumenting/exporters/

### Grafana
 - https://grafana.com/
 - https://grafana.com/docs/grafana/latest/installation/docker/
 - https://www.petecodes.co.uk/configuring-and-visualising-iot-edge-metrics-using-prometheus-and-grafana/
 - https://grafana.com/docs/grafana/latest/administration/configuration/
 - https://grafana.com/docs/grafana-cloud/quickstart/docker-compose-linux/

### Node exporter
 - https://hub.docker.com/r/prom/node-exporter
 - https://hub.docker.com/r/prom/node-exporter/tags
 - https://grafana.com/docs/grafana-cloud/quickstart/docker-compose-linux/
 - https://grafana.com/grafana/dashboards/1860
 - https://prometheus.io/docs/guides/node-exporter/

### Process exporter
 - https://github.com/ncabatoff/process-exporter
